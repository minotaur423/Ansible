- hosts: db
  vars:
    - dbpass: mypassword
    - firstrun: false
  tasks:
    - name: Download and install mariadb
      yum: name={{ item }} state=present
      with_items:
        - mariadb-server
        - MySQL-python
      tags: yum
      
    - block:
      - name: Configure the root password for mariadb
        mysql_user:
          name: root
          host: localhost
          password: '{{ dbpass }}'
        tags: 
          - user
          - root
      - name: Remove anonymous user accounts
        mysql_user:
          name: ''
          host_all: yes
          state: absent
          login_user: root
          login_password: '{{ dbpass }}'
        tags:
          - user
          - anon
      when: firstrun == true
  
    - name: Create application database
      mysql_db:
        name: appdb
        state: present
        login_user: root
        login_password: '{{ dbpass }}'
      tags:
        - createdb
    - name: Create application user
      mysql_user:
        name: codeigniter
        host: '%'
        password: cipassword
        priv: appdb.*:ALL
        state: present
        login_user: root
        login_password: '{{ dbpass }}'
      tags:
        - user
        - appuser
    - name: Upload create.sql
      become: yes
      copy:
        src: /vagrant/create.sql
        dest: /tmp/
      tags: dummy_records
    - name: Execute mysql script
      mysql_db:
        name: appdb
        login_user: root
        login_password: '{{ dbpass }}'
        state: import
        target: /tmp/create.sql
      tags: dummy_records